name: Auto-Update LeetCode Progress

on:
  schedule:
    - cron: "0 */6 * * *"  # Runs every 6 hours
  workflow_dispatch:  # Allows manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install requests

      - name: Fetch LeetCode Progress and Update README
        run: |
          python <<EOF
          import requests
          import datetime
          import re

          LEETCODE_USERNAME = "raziord2717"
          README_FILE = "README.md"

          def fetch_solved_problems():
              url = f"https://leetcode-stats-api.herokuapp.com/{LEETCODE_USERNAME}"
              response = requests.get(url)

              print(f"ðŸ“¡ Fetching LeetCode Data from {url}")
              print(f"ðŸ”„ API Response Code: {response.status_code}")

              if response.status_code != 200:
                  print(f"âŒ API Fetch Failed. Status Code: {response.status_code}")
                  exit(1)

              data = response.json()
              print("âœ… API Data:", data)
              return data

          # Fetch latest LeetCode data
          leetcode_data = fetch_solved_problems()
          last_updated = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")

          # Read existing README
          with open(README_FILE, "r") as file:
              readme_content = file.read()

          # Extract current solved problems from README using regex
          match = re.search(r"Total Solved: (\d+)/(\d+)", readme_content)
          current_solved = int(match.group(1)) if match else 0

          new_solved = int(leetcode_data.get("totalSolved", "0"))

          # Only update README if the total solved count has changed
          if new_solved > current_solved:
              replacements = {
                  "{{total_solved}}": str(new_solved),
                  "{{total_questions}}": str(leetcode_data.get("totalQuestions", "0")),
                  "{{easy_solved}}": str(leetcode_data.get("easySolved", "0")),
                  "{{total_easy}}": str(leetcode_data.get("totalEasy", "0")),
                  "{{medium_solved}}": str(leetcode_data.get("mediumSolved", "0")),
                  "{{total_medium}}": str(leetcode_data.get("totalMedium", "0")),
                  "{{hard_solved}}": str(leetcode_data.get("hardSolved", "0")),
                  "{{total_hard}}": str(leetcode_data.get("totalHard", "0")),
                  "{{last_updated}}": last_updated
              }

              for key, value in replacements.items():
                  print(f"ðŸ”„ Replacing {key} with {value}")
                  readme_content = readme_content.replace(key, value)

              with open(README_FILE, "w") as file:
                  file.write(readme_content)

              print("âœ… README.md Updated Successfully!")

              # Mark for commit
              exit(0)
          else:
              print("âœ… No new progress detected. Skipping commit.")
              exit(1)  # Exit with a non-zero code to prevent Git commit step
          EOF

      - name: Commit and Push Changes
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md

          # Commit only if changes are detected
          git commit -m "ðŸ”„ Auto-update LeetCode progress"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/Charanbyreddy/Leetcode-Progress.git main
